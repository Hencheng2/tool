<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Visual Webpage Builder — Edit / View Modes</title>
  <style>
    :root{
      --bg:#0b0f14; --panel:#0f1720; --muted:#9aa5b1; --accent:#6ee7b7; --glass: rgba(255,255,255,0.03);
      --radius:12px; --gap:12px; --card:#0f1720;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial;-webkit-font-smoothing:antialiased;color:#e6eef6;background:linear-gradient(180deg,#071018 0%, #081218 100%)}

    /* Shell */
    .app{display:flex;height:100vh;gap:var(--gap);padding:18px}
    .left,.right{background:var(--panel);border-radius:14px;padding:14px;box-shadow:0 6px 18px rgba(2,6,23,0.6);} 
    .left{width:320px;display:flex;flex-direction:column;gap:12px}
    .center{flex:1;display:flex;flex-direction:column;gap:12px}
    .right{width:420px;display:flex;flex-direction:column;gap:12px}

    /* Header */
    .topbar{display:flex;align-items:center;gap:10px}
    .logo{font-weight:700;color:var(--accent);font-size:14px}
    .modes{margin-left:auto;display:flex;gap:6px}
    .btn{background:var(--glass);color:var(--muted);padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);cursor:pointer}
    .btn.active{background:linear-gradient(90deg, rgba(110,231,183,0.12), rgba(110,231,183,0.04));color:var(--accent);border:1px solid rgba(110,231,183,0.12)}

    /* Palette */
    .palette{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .element-card{background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);padding:8px;border-radius:10px;display:flex;flex-direction:column;gap:8px;cursor:pointer;border:1px solid rgba(255,255,255,0.02)}
    .element-card small{color:var(--muted)}

    /* Workspace area */
    .canvas-shell{display:flex;flex-direction:column;gap:10px;align-items:center}
    .screen-toggles{display:flex;gap:8px}
    .screen-btn{padding:6px 8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.03);cursor:pointer;color:var(--muted)}
    .screen-btn.active{color:var(--accent);border:1px solid rgba(110,231,183,0.12)}

    .viewport{width:100%;max-width:1100px;display:flex;justify-content:center}
    .page-frame{background:linear-gradient(180deg,#071421,#07101a);border-radius:10px;padding:18px;border:1px solid rgba(255,255,255,0.03);width:100%;height:640px;box-shadow:0 20px 40px rgba(2,6,23,0.6);overflow:auto;position:relative}

    /* device sizes */
    .device-desktop .page-frame{width:100%;max-width:1000px}
    .device-laptop .page-frame{width:900px}
    .device-tablet .page-frame{width:720px}
    .device-phone .page-frame{width:380px;height:780px}

    /* editable page (the actual output) */
    #page{min-height:540px;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);border-radius:8px;padding:18px;color:#eef6ff}
    #page [data-selectable]{outline:2px dashed transparent;padding:6px;border-radius:8px}
    #page [data-selectable].selected{outline:2px dashed rgba(110,231,183,0.18);background:rgba(110,231,183,0.02)}

    /* Properties panel */
    .panel{background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);padding:12px;border-radius:10px;min-height:120px}
    .prop-row{display:flex;gap:8px;align-items:center;margin-bottom:8px}
    .prop-row label{font-size:12px;color:var(--muted);min-width:80px}
    .prop-row input,.prop-row select,.prop-row textarea{flex:1;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:#e6eef6}

    /* code areas */
    .code-area{display:flex;flex-direction:column;gap:8px}
    .code-area textarea{height:120px;background:#07131a;border-radius:8px;padding:10px;color:#bfe7d6;border:1px solid rgba(255,255,255,0.03);resize:vertical}
    .code-actions{display:flex;justify-content:space-between;align-items:center}

    /* toolbar small */
    .small{font-size:13px;color:var(--muted)}

    /* modal preview helper */
    .modal-backdrop{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,6,23,0.6)}
    .modal-backdrop.show{display:flex}
    .modal{background:#071522;padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);min-width:320px}

    footer{font-size:12px;color:var(--muted);text-align:center;padding-top:6px}

    /* responsive layout for the builder itself */
    @media (max-width:1100px){.left{display:none}.right{display:none}.center{flex:1}}
  </style>
</head>
<body>
  <div class="app">
    <div class="left">
      <div class="topbar">
        <div class="logo">Builder • Dark</div>
        <div class="modes">
          <button id="mode-edit" class="btn active">Edit</button>
          <button id="mode-view" class="btn">View</button>
        </div>
      </div>

      <div class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div class="small">Elements</div>
          <div class="small">Drag or click to add</div>
        </div>
        <div class="palette" id="palette">
          <div class="element-card" data-type="navbar">
            <strong>Navbar</strong>
            <small>Responsive top navigation</small>
          </div>
          <div class="element-card" data-type="hero">
            <strong>Hero / Header</strong>
            <small>Title + subtitle + cta</small>
          </div>
          <div class="element-card" data-type="card">
            <strong>Card</strong>
            <small>Image + content</small>
          </div>
          <div class="element-card" data-type="button">
            <strong>Button</strong>
            <small>Primary action</small>
          </div>
          <div class="element-card" data-type="modal">
            <strong>Modal</strong>
            <small>Dialog / popup</small>
          </div>
          <div class="element-card" data-type="form">
            <strong>Form</strong>
            <small>Inputs + submit</small>
          </div>
          <div class="element-card" data-type="toggle">
            <strong>Toggle</strong>
            <small>On/off switch</small>
          </div>
          <div class="element-card" data-type="footer">
            <strong>Footer</strong>
            <small>Page footer</small>
          </div>
        </div>
      </div>

      <div class="panel">
        <div class="small" style="margin-bottom:8px">Screen</div>
        <div class="screen-toggles">
          <button class="screen-btn active" data-device="device-desktop">Desktop</button>
          <button class="screen-btn" data-device="device-laptop">Laptop</button>
          <button class="screen-btn" data-device="device-tablet">Tablet</button>
          <button class="screen-btn" data-device="device-phone">Phone</button>
        </div>
      </div>

      <div class="panel small">
        <div style="display:flex;justify-content:space-between;align-items:center"><strong>Hints</strong></div>
        <div style="margin-top:8px;color:var(--muted);font-size:13px">Click an element on the page to edit. Use the palette to insert common elements. Copy generated HTML/CSS/JS from the right panel.</div>
      </div>
    </div>

    <div class="center">
      <div class="canvas-shell">
        <div style="display:flex;gap:12px;align-items:center">
          <div class="small">Preview</div>
          <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
            <button id="show-code" class="btn">Export</button>
            <div class="small">Mode: <span id="mode-indicator">Edit</span></div>
          </div>
        </div>

        <div class="viewport device-desktop" id="viewport">
          <div class="page-frame">
            <div id="page" contenteditable="false">
              <!-- default starter page -->
              <nav data-selectable data-type="navbar" style="display:flex;justify-content:space-between;align-items:center;padding:12px 6px;background:transparent">
                <div style="font-weight:700">Brand</div>
                <div style="display:flex;gap:8px"><a href="#">Home</a><a href="#">About</a><a href="#">Contact</a></div>
              </nav>

              <section data-selectable data-type="hero" style="padding:40px 10px">
                <h1 contenteditable="true">Welcome to your page</h1>
                <p contenteditable="true">A short subtitle goes here. Use the right panel to edit properties.</p>
                <div style="margin-top:12px"><button data-selectable data-type="button">Get started</button></div>
              </section>

              <section style="display:flex;gap:12px;flex-wrap:wrap">
                <article data-selectable data-type="card" style="flex:1;min-width:220px;padding:12px;background:rgba(255,255,255,0.02);border-radius:10px">
                  <h3 contenteditable="true">Card title</h3>
                  <p contenteditable="true">Card body text goes here.</p>
                  <button data-selectable data-type="button">Read more</button>
                </article>

                <article data-selectable data-type="card" style="flex:1;min-width:220px;padding:12px;background:rgba(255,255,255,0.02);border-radius:10px">
                  <h3 contenteditable="true">Another card</h3>
                  <p contenteditable="true">More supporting text.</p>
                  <button data-selectable data-type="button">Action</button>
                </article>
              </section>

              <footer data-selectable data-type="footer" style="padding:20px 6px;margin-top:20px;border-top:1px solid rgba(255,255,255,0.02);">
                <small>© Your Company</small>
              </footer>

              <!-- modal placeholder -->
              <div id="builder-modal" style="display:none"></div>
            </div>
          </div>
        </div>

      </div>

      <footer>Quick builder — dark theme • HTML/CSS/JS export</footer>
    </div>

    <div class="right">
      <div class="panel">
        <div class="small" style="margin-bottom:8px">Selected element</div>
        <div id="properties">
          <div class="small" style="color:var(--muted)">No element selected</div>
        </div>
      </div>

      <div class="panel code-area">
        <div class="code-actions">
          <div class="small">HTML</div>
          <div>
            <button class="btn" data-copy-target="#html-code">Copy</button>
          </div>
        </div>
        <textarea id="html-code" readonly></textarea>

        <div class="code-actions">
          <div class="small">CSS</div>
          <div>
            <button class="btn" data-copy-target="#css-code">Copy</button>
          </div>
        </div>
        <textarea id="css-code" readonly></textarea>

        <div class="code-actions">
          <div class="small">JS</div>
          <div>
            <button class="btn" data-copy-target="#js-code">Copy</button>
          </div>
        </div>
        <textarea id="js-code" readonly></textarea>
      </div>

      <div class="panel small">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>Export / Preview</div>
          <div style="display:flex;gap:8px">
            <button id="open-preview" class="btn">Open Live Preview</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- modal backdrop for previewing page behaviors -->
  <div id="modal-backdrop" class="modal-backdrop"><div class="modal"><div id="modal-content"></div><div style="text-align:right;margin-top:8px"><button id="close-modal" class="btn">Close</button></div></div></div>

  <script>
    // Simple builder logic: insertion, selection, properties, screen toggles, export
    const palette = document.getElementById('palette');
    const page = document.getElementById('page');
    const properties = document.getElementById('properties');
    const modeIndicator = document.getElementById('mode-indicator');
    const modeEditBtn = document.getElementById('mode-edit');
    const modeViewBtn = document.getElementById('mode-view');
    const viewport = document.getElementById('viewport');
    const screenButtons = document.querySelectorAll('.screen-btn');
    const htmlCode = document.getElementById('html-code');
    const cssCode = document.getElementById('css-code');
    const jsCode = document.getElementById('js-code');
    const copyButtons = document.querySelectorAll('[data-copy-target]');
    const openPreviewBtn = document.getElementById('open-preview');
    const showCodeBtn = document.getElementById('show-code');
    const modalBackdrop = document.getElementById('modal-backdrop');
    const modalContent = document.getElementById('modal-content');
    const closeModal = document.getElementById('close-modal');

    let selectedEl = null;
    let mode = 'edit';

    function setMode(m){
      mode = m; modeIndicator.textContent = m[0].toUpperCase()+m.slice(1);
      document.body.querySelectorAll('.btn').forEach(b=>b.classList.remove('active'));
      if(m==='edit') modeEditBtn.classList.add('active'); else modeViewBtn.classList.add('active');
      // toggle contenteditable and selection behavior
      if(m==='view'){
        page.querySelectorAll('[data-selectable]').forEach(e=>e.classList.remove('selected'));
        selectedEl = null; renderProperties();
        page.setAttribute('contenteditable','false');
      } else {
        page.setAttribute('contenteditable','false');
      }
    }
    setMode('edit');

    // Insert element from palette
    palette.addEventListener('click', e=>{
      const card = e.target.closest('.element-card'); if(!card) return;
      const type = card.getAttribute('data-type');
      insertElement(type);
      generateAllCode();
    });

    function insertElement(type){
      let el;
      switch(type){
        case 'navbar':
          el = document.createElement('nav'); el.setAttribute('data-selectable',''); el.setAttribute('data-type','navbar');
          el.innerHTML = '<div style="font-weight:700">Brand</div><div style="display:flex;gap:8px"><a href="#">Home</a><a href="#">Features</a><a href="#">Pricing</a></div>';
          break;
        case 'hero':
          el = document.createElement('section'); el.setAttribute('data-selectable',''); el.setAttribute('data-type','hero');
          el.innerHTML = '<h1 contenteditable="true">Hero heading</h1><p contenteditable="true">Short description</p><button data-selectable data-type="button">Call to action</button>';
          break;
        case 'card':
          el = document.createElement('article'); el.setAttribute('data-selectable',''); el.setAttribute('data-type','card');
          el.style.padding='12px'; el.style.background='rgba(255,255,255,0.02)'; el.style.borderRadius='10px'; el.innerHTML='<h3 contenteditable="true">Card title</h3><p contenteditable="true">Card text</p><button data-selectable data-type="button">Action</button>';
          break;
        case 'button':
          el = document.createElement('button'); el.setAttribute('data-selectable',''); el.setAttribute('data-type','button'); el.textContent='Button';
          break;
        case 'modal':
          const uid = 'modal-'+Date.now();
          el = document.createElement('div'); el.setAttribute('data-selectable',''); el.setAttribute('data-type','modal');
          el.innerHTML = `<button class=\"open-modal\">Open modal</button><div class=\"_modal-instance\" data-modal-id=\"${uid}\" style=\"display:none\">\n  <h3 contenteditable=\"true\">Modal title</h3>\n  <p contenteditable=\"true\">Modal content</p>\n</div>`;
          break;
        case 'form':
          el = document.createElement('form'); el.setAttribute('data-selectable',''); el.setAttribute('data-type','form');
          el.innerHTML = '<label> Email <input placeholder="you@company.com"/></label><br/><button type="submit">Submit</button>';
          break;
        case 'toggle':
          el = document.createElement('label'); el.setAttribute('data-selectable',''); el.setAttribute('data-type','toggle');
          el.innerHTML = '<input type="checkbox"/> <span>Toggle</span>';
          break;
        case 'footer':
          el = document.createElement('footer'); el.setAttribute('data-selectable',''); el.setAttribute('data-type','footer'); el.innerHTML='<small>© Company</small>';
          break;
        default:
          el = document.createElement('div'); el.setAttribute('data-selectable',''); el.textContent = 'New block';
      }
      page.appendChild(el);
      attachSelectable(el);
    }

    // Selection handling
    function attachSelectable(root){
      root.querySelectorAll('[data-selectable]').forEach(el=>{
        el.addEventListener('click', e=>{
          e.stopPropagation();
          if(mode==='view') return; // no selecting in view mode
          if(selectedEl) selectedEl.classList.remove('selected');
          selectedEl = el; el.classList.add('selected');
          renderProperties();
        });
      });
      // also make the element root selectable
      if(root.hasAttribute && root.hasAttribute('data-selectable')){
        const el = root;
        el.addEventListener('click', e=>{
          e.stopPropagation();
          if(mode==='view') return;
          if(selectedEl) selectedEl.classList.remove('selected');
          selectedEl = el; el.classList.add('selected'); renderProperties();
        });
      }
    }

    // make existing selectable items attach events
    document.querySelectorAll('[data-selectable]').forEach(el=>attachSelectable(el));

    // deselect when clicking outside
    document.addEventListener('click', e=>{
      if(selectedEl){ selectedEl.classList.remove('selected'); selectedEl = null; renderProperties(); }
    });

    // render properties panel
    function renderProperties(){
      if(!selectedEl){ properties.innerHTML = '<div class="small" style="color:var(--muted)">No element selected</div>'; return; }
      const type = selectedEl.getAttribute('data-type')||selectedEl.tagName.toLowerCase();
      properties.innerHTML = '';

      // title
      const title = document.createElement('div'); title.className='small'; title.style.fontWeight='600'; title.textContent = 'Type: '+type; properties.appendChild(title);

      // text content
      const textRow = document.createElement('div'); textRow.className='prop-row';
      const label = document.createElement('label'); label.textContent='Text';
      const input = document.createElement('input'); input.value = selectedEl.innerText.trim();
      input.addEventListener('input', ()=>{ // only change text nodes if element doesn't have complex children
        // if element has contenteditable children keep them
        if(selectedEl.querySelector('[contenteditable]')) return;
        selectedEl.textContent = input.value;
        generateAllCode();
      });
      textRow.appendChild(label); textRow.appendChild(input); properties.appendChild(textRow);

      // background color
      const bgRow = document.createElement('div'); bgRow.className='prop-row';
      const lbl2 = document.createElement('label'); lbl2.textContent='Background';
      const bgInput = document.createElement('input'); bgInput.type='color';
      // try to compute current background
      const bg = window.getComputedStyle(selectedEl).backgroundColor;
      function rgbaToHex(rgb){
        if(!rgb) return '#000000';
        const nums = rgb.replace(/rgba?\(|\s+|\)/g,'').split(',');
        const r = parseInt(nums[0]||0), g = parseInt(nums[1]||0), b = parseInt(nums[2]||0);
        return '#'+[r,g,b].map(x=>x.toString(16).padStart(2,'0')).join('');
      }
      try{ bgInput.value = rgbaToHex(bg); }catch(e){ bgInput.value='#000000'; }
      bgInput.addEventListener('input', ()=>{ selectedEl.style.background = bgInput.value; generateAllCode(); });
      bgRow.appendChild(lbl2); bgRow.appendChild(bgInput); properties.appendChild(bgRow);

      // text size
      const sizeRow = document.createElement('div'); sizeRow.className='prop-row';
      const l3 = document.createElement('label'); l3.textContent='Font size';
      const sizeInput = document.createElement('input'); sizeInput.type='number'; sizeInput.value = parseInt(window.getComputedStyle(selectedEl).fontSize)||16;
      sizeInput.addEventListener('input', ()=>{ selectedEl.style.fontSize = sizeInput.value+'px'; generateAllCode(); });
      sizeRow.appendChild(l3); sizeRow.appendChild(sizeInput); properties.appendChild(sizeRow);

      // link for anchors / buttons
      if(selectedEl.tagName.toLowerCase()==='a' || (selectedEl.getAttribute('data-type')==='button')){
        const linkRow = document.createElement('div'); linkRow.className='prop-row';
        const l4 = document.createElement('label'); l4.textContent='URL';
        const linkInput = document.createElement('input'); linkInput.placeholder='https://';
        linkInput.value = selectedEl.getAttribute('href')||selectedEl.getAttribute('data-href')||'';
        linkInput.addEventListener('input', ()=>{ if(selectedEl.tagName.toLowerCase()==='a') selectedEl.href = linkInput.value; else selectedEl.setAttribute('data-href', linkInput.value); generateAllCode(); });
        linkRow.appendChild(l4); linkRow.appendChild(linkInput); properties.appendChild(linkRow);
      }

      // alignment
      const alignRow = document.createElement('div'); alignRow.className='prop-row';
      const l5 = document.createElement('label'); l5.textContent='Align';
      const sel = document.createElement('select'); ['inherit','left','center','right'].forEach(v=>{ const opt=document.createElement('option'); opt.value=v; opt.textContent=v; sel.appendChild(opt)});
      sel.value = window.getComputedStyle(selectedEl).textAlign || 'inherit';
      sel.addEventListener('change', ()=>{ selectedEl.style.textAlign = sel.value; generateAllCode(); });
      alignRow.appendChild(l5); alignRow.appendChild(sel); properties.appendChild(alignRow);

      // delete
      const delRow = document.createElement('div'); delRow.style.display='flex'; delRow.style.justifyContent='flex-end';
      const delBtn = document.createElement('button'); delBtn.className='btn'; delBtn.textContent='Delete';
      delBtn.addEventListener('click', ()=>{ selectedEl.remove(); selectedEl=null; renderProperties(); generateAllCode(); }); delRow.appendChild(delBtn); properties.appendChild(delRow);
    }

    // attach for current elements
    function initAttach(){ document.querySelectorAll('[data-selectable]').forEach(el=>attachSelectable(el)); }
    initAttach();

    // screen toggles
    screenButtons.forEach(b=>b.addEventListener('click', ()=>{
      screenButtons.forEach(x=>x.classList.remove('active'));
      b.classList.add('active'); const device = b.getAttribute('data-device');
      document.querySelectorAll('.viewport').forEach(v=>v.className='viewport');
      viewport.className = 'viewport '+device;
    }));

    // copy button logic
    copyButtons.forEach(btn=>btn.addEventListener('click', ()=>{
      const target = document.querySelector(btn.getAttribute('data-copy-target'));
      target.select(); document.execCommand('copy'); btn.textContent='Copied'; setTimeout(()=>btn.textContent='Copy',1000);
    }));

    // export / generate code
    function generateAllCode(){
      // HTML: innerHTML of page but cleaned of builder-only attributes
      const clone = page.cloneNode(true);
      // remove selection markers and builder IDs
      clone.querySelectorAll('[data-selectable]').forEach(node=>{
        node.removeAttribute('data-selectable'); node.removeAttribute('data-type'); node.classList.remove('selected');
        if(node.hasAttribute('data-href')){ const h = node.getAttribute('data-href'); if(node.tagName.toLowerCase()!=='a'){ const a = document.createElement('a'); a.href = h; a.innerHTML = node.innerHTML; node.parentNode.replaceChild(a,node); } else { node.href = h; } }
      });
      // pick up modal instances
      // create CSS: minimal to include builder basics for export
      const exportedHTML = '<!doctype html>\n<html>\n<head>\n<meta charset="utf-8">\n<meta name="viewport" content="width=device-width,initial-scale=1">\n<link rel="stylesheet" href="styles.css">\n</head>\n<body>\n'+clone.innerHTML+'\n<script src="script.js"></script>\n</body>\n</html>';

      const exportedCSS = `/* Basic exported styles (minimal) */\nbody{font-family:Inter,system-ui,Arial;line-height:1.4;background:#07101a;color:#e9f3ff;padding:20px}\nbutton{background:#147a5a;color:white;padding:8px 12px;border-radius:8px;border:none}\nnav a{margin-left:8px;color:inherit;text-decoration:none}\n.card{background:rgba(255,255,255,0.02);padding:12px;border-radius:10px}\n`;

      const exportedJS = `// Minimal exported JS to support modals and data-href buttons\ndocument.addEventListener('click', function(e){
  if(e.target.matches('[data-href]')){
    const url = e.target.getAttribute('data-href'); if(url) window.location.href = url;
  }
  if(e.target.matches('.open-modal')){
    const inst = e.target.parentNode.querySelector('._modal-instance'); if(inst){ const modal = document.createElement('div'); modal.style.position='fixed';modal.style.inset=0;modal.style.display='flex';modal.style.alignItems='center';modal.style.justifyContent='center';modal.style.background='rgba(0,0,0,0.6)'; modal.innerHTML = '<div style="background:#fff;color:#000;padding:20px;border-radius:10px;max-width:90%">'+inst.innerHTML+'<div style="text-align:right;margin-top:12px"><button id=\"_close\">Close</button></div></div>'; document.body.appendChild(modal); modal.querySelector('#_close').addEventListener('click', ()=>modal.remove()); }
  }
});`;

      htmlCode.value = exportedHTML;
      cssCode.value = exportedCSS;
      jsCode.value = exportedJS;
    }

    // initial generation
    generateAllCode();

    // open live preview — opens a new window with the generated HTML/CSS/JS inlined
    openPreviewBtn.addEventListener('click', ()=>{
      const w = window.open();
      const html = htmlCode.value.replace('<link rel="stylesheet" href="styles.css">', '<style>'+cssCode.value+'</style>').replace('<script src="script.js"></script>', '<script>'+jsCode.value+'<\/script>');
      w.document.open(); w.document.write(html); w.document.close();
    });

    // show code toggles
    showCodeBtn.addEventListener('click', ()=>{
      // simple scroll to right panel
      document.querySelector('.right').scrollIntoView({behavior:'smooth'});
    });

    // modal backdrop close
    closeModal.addEventListener('click', ()=>{ modalBackdrop.classList.remove('show'); modalContent.innerHTML=''; });

    // hook into dynamic modal open from builder elements
    page.addEventListener('click', e=>{
      if(e.target.classList.contains('open-modal')){
        e.stopPropagation(); const inst = e.target.parentNode.querySelector('._modal-instance'); if(inst){ modalContent.innerHTML = inst.innerHTML; modalBackdrop.classList.add('show'); }
      }
      // open data-href
      if(e.target.hasAttribute('data-href') && mode==='view'){
        window.location.href = e.target.getAttribute('data-href');
      }
    });

    // selection events for newly added content (mutation observer)
    const mo = new MutationObserver(muts=>{ muts.forEach(m=>{ m.addedNodes && m.addedNodes.forEach(n=>{ if(n.nodeType===1) attachSelectable(n); }); }); generateAllCode(); });
    mo.observe(page, {childList:true, subtree:true});

    // keyboard shortcuts: delete selected
    document.addEventListener('keydown', e=>{ if(e.key==='Delete' && selectedEl){ selectedEl.remove(); selectedEl=null; renderProperties(); generateAllCode(); } });

    // keep code updated when contenteditable children change
    page.addEventListener('input', ()=>generateAllCode());

    // simple save/load from localStorage
    window.addEventListener('beforeunload', ()=>{ localStorage.setItem('builder_html', page.innerHTML); });
    (function(){ const saved = localStorage.getItem('builder_html'); if(saved) page.innerHTML = saved; initAttach(); generateAllCode(); })();

    // mode switch
    modeEditBtn.addEventListener('click', ()=>setMode('edit'));
    modeViewBtn.addEventListener('click', ()=>setMode('view'));

  </script>
</body>
</html>
