<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Web Designer Tool (Prototype)</title>
  <style>
    :root{
      --bg:#0f1720;
      --panel:#0b1220;
      --muted:#94a3b8;
      --accent:#7c3aed;
      --card:#0b1522;
      --glass: rgba(255,255,255,0.03);
    }
    *{box-sizing:border-box;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#071021 0%,#081226 100%);color:#e6eef8}
    .app{display:grid;grid-template-columns:260px 1fr 320px;grid-template-rows:58px 1fr 420px;height:100vh;gap:14px;padding:14px}
    header{grid-column:1/-1;display:flex;align-items:center;justify-content:space-between;padding:10px 16px;border-radius:10px;background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));box-shadow:0 4px 18px rgba(2,6,23,0.6)}
    header .brand{display:flex;gap:12px;align-items:center}
    header h1{font-size:16px;margin:0}
    header .controls{display:flex;gap:8px;align-items:center}
    .btn{background:var(--accent);color:white;padding:8px 12px;border-radius:8px;border:0;cursor:pointer;font-weight:600}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06)}
    .left,.right{border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:12px;overflow:auto}
    .left h3,.right h3{margin:0 0 8px 0;font-size:13px;color:var(--muted)}
    .tool-item{padding:10px;border-radius:8px;background:var(--card);margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;cursor:pointer}
    .canvas-wrap{border-radius:10px;padding:10px;display:flex;flex-direction:column;gap:8px}
    .toolbar{display:flex;gap:8px;align-items:center}
    .work-area{flex:1;border-radius:8px;background:linear-gradient(180deg,#06202b,#05202b);padding:20px;overflow:auto;display:flex;justify-content:center;align-items:flex-start;min-height:420px}
    .page{width:1000px;min-height:600px;background:white;border-radius:8px;box-shadow:0 6px 30px rgba(3,7,18,0.6);overflow:hidden;position:relative}
    .page *{box-sizing:border-box}
    .toolbox-grid{display:grid;grid-template-columns:1fr;gap:8px}
    .prop-row{display:flex;gap:8px;margin-bottom:8px;align-items:center}
    .prop-row label{min-width:70px;color:var(--muted);font-size:13px}
    .input,select{background:#071121;border:1px solid rgba(255,255,255,0.03);padding:8px;border-radius:6px;color:#e2eefb;flex:1}
    .color-input{width:56px;height:36px;border-radius:6px;border:1px solid rgba(255,255,255,0.04)}
    .prop-actions{display:flex;gap:8px}
    .meta{font-size:12px;color:var(--muted);margin-bottom:8px}
    .edit-mode-indicator{padding:6px 10px;border-radius:8px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03)}
    /* selection */
    .selected-outline{outline:2px dashed var(--accent);box-shadow:0 0 0 3px rgba(124,58,237,0.06)}
    /* bottom editors */
    .editors{grid-column:1/-1;display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    .editor-card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:10px;overflow:hidden;display:flex;flex-direction:column}
    .editor-head{display:flex;align-items:center;justify-content:space-between;padding:8px 12px;border-bottom:1px solid rgba(255,255,255,0.02)}
    .editor-title{font-size:13px;color:var(--muted)}
    .copy-btn{background:rgba(255,255,255,0.03);border:0;padding:6px 10px;border-radius:8px;color:#dbeafe;cursor:pointer}
    /* small helpers */
    .row{display:flex;gap:8px}
    .navbar-edit-list{display:flex;gap:6px;align-items:center}
    .navbar-item{background:#081426;padding:6px 10px;border-radius:6px;border:1px solid rgba(255,255,255,0.02);cursor:pointer}
    .control-sm{padding:6px 8px;border-radius:6px;background:#071227;border:1px solid rgba(255,255,255,0.02);color:#cfe6ff}
    /* mobile responsiveness */
    @media (max-width:1100px){
      .app{grid-template-columns:1fr;grid-template-rows:58px auto 420px;gap:10px}
      .left,.right{height:260px}
      .editors{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="brand">
        <svg width="36" height="36" viewBox="0 0 24 24" fill="none"><rect width="24" height="24" rx="6" fill="#7C3AED"/><path d="M7 9h10M7 15h10" stroke="white" stroke-linecap="round" stroke-linejoin="round"/></svg>
        <div>
          <h1>Designer Studio</h1>
          <div style="font-size:12px;color:var(--muted)">Drag, Edit, & Export HTML/CSS/JS</div>
        </div>
      </div>
      <div class="controls">
        <div class="edit-mode-indicator" id="modeIndicator">Mode: Edit</div>
        <button class="btn ghost" id="togglePreview">Toggle Preview</button>
        <button class="btn" id="resetBtn">Reset</button>
      </div>
    </header>

    <aside class="left">
      <h3>Toolbox</h3>
      <div class="toolbox-grid">
        <div class="tool-item" data-comp="navbar"><div>Navbar</div><div class="control-sm">Add</div></div>
        <div class="tool-item" data-comp="section"><div>Section / Container</div><div class="control-sm">Add</div></div>
        <div class="tool-item" data-comp="text"><div>Text</div><div class="control-sm">Add</div></div>
        <div class="tool-item" data-comp="button"><div>Button</div><div class="control-sm">Add</div></div>
        <div class="tool-item" data-comp="image"><div>Image</div><div class="control-sm">Add</div></div>
        <div class="tool-item" data-comp="video"><div>Video</div><div class="control-sm">Add</div></div>
        <div class="tool-item" data-comp="modal"><div>Modal</div><div class="control-sm">Add</div></div>
      </div>

      <h3>Tips</h3>
      <div class="meta">Select elements in the canvas to see/edit their properties. Drag to move, drag edges to resize. Use the editors below to copy generated code.</div>
    </aside>

    <main class="canvas-wrap">
      <div class="toolbar">
        <div style="display:flex;gap:8px;align-items:center">
          <div class="btn ghost" id="addSample">Add Sample Layout</div>
          <div class="btn ghost" id="autoFit">Fit Canvas Width</div>
        </div>
        <div style="flex:1"></div>
        <div style="color:var(--muted);font-size:13px">Selected: <span id="selectedLabel">none</span></div>
      </div>
      <div class="work-area" id="workArea">
        <div class="page" id="pageCanvas" contenteditable="false" spellcheck="false">
          <!-- initial blank page -->
        </div>
      </div>
    </main>

    <aside class="right">
      <h3>Properties</h3>
      <div id="propsPanel">
        <div class="meta">No element selected. Click an element in the page to edit its properties.</div>
      </div>
      <hr style="border:none;border-top:1px solid rgba(255,255,255,0.02);margin:12px 0">
      <div style="display:flex;gap:8px;align-items:center">
        <div style="font-size:13px;color:var(--muted)">Page background</div>
        <input type="color" id="pageBg" class="color-input" value="#ffffff" />
      </div>
    </aside>

    <div class="editors">
      <div class="editor-card">
        <div class="editor-head">
          <div class="editor-title">HTML</div>
          <div><button class="copy-btn" data-copy="html">Copy</button></div>
        </div>
        <div id="htmlEditor" style="height:360px;background:#021021"></div>
      </div>

      <div class="editor-card">
        <div class="editor-head">
          <div class="editor-title">CSS</div>
          <div><button class="copy-btn" data-copy="css">Copy</button></div>
        </div>
        <div id="cssEditor" style="height:360px;background:#021021"></div>
      </div>

      <div class="editor-card">
        <div class="editor-head">
          <div class="editor-title">JS</div>
          <div><button class="copy-btn" data-copy="js">Copy</button></div>
        </div>
        <div id="jsEditor" style="height:360px;background:#021021"></div>
      </div>
    </div>
  </div>

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <script>
    // Utility functions
    function el(tag, attrs={}, children=[]){
      const e = document.createElement(tag);
      for(const k in attrs){
        if(k==='class') e.className = attrs[k];
        else if(k==='html') e.innerHTML = attrs[k];
        else e.setAttribute(k, attrs[k]);
      }
      (Array.isArray(children)?children:[children]).forEach(c=>{ if(!c) return; if(typeof c === 'string') e.appendChild(document.createTextNode(c)); else e.appendChild(c);});
      return e;
    }

    const page = document.getElementById('pageCanvas');
    const workArea = document.getElementById('workArea');
    const propsPanel = document.getElementById('propsPanel');
    const selectedLabel = document.getElementById('selectedLabel');
    const pageBg = document.getElementById('pageBg');

    let selectedEl = null;
    let editorsReady = false;

    // initial styles for the inner page
    page.style.background = '#ffffff';

    // Helper: create component with base structure and data-type
    function createComponent(type){
      const wrapper = el('div',{class:'comp '+type,'data-type':type, 'style':'position:relative;'});
      wrapper.dataset.id = 'c'+Date.now()+Math.floor(Math.random()*1000);
      wrapper.style.minWidth = '80px';
      wrapper.style.minHeight = '36px';
      wrapper.style.display = 'inline-block';
      wrapper.style.padding = '8px';
      wrapper.style.boxSizing = 'border-box';
      wrapper.style.borderRadius = '6px';
      wrapper.style.color = '#0b1220';
      wrapper.style.background = 'transparent';
      wrapper.style.fontFamily = 'inherit';

      switch(type){
        case 'section':
          wrapper.style.display = 'block';
          wrapper.style.width = '100%';
          wrapper.style.minHeight='160px';
          wrapper.style.padding='24px';
          wrapper.style.background = 'linear-gradient(180deg,#f8fafc,#ffffff)';
          wrapper.innerHTML = '<div contenteditable="true" class="inner-text" style="font-size:20px;color:#0b1220">Section title</div><div contenteditable="true" class="inner-text" style="margin-top:8px;color:#0b1220">Some content... </div>';
          break;
        case 'navbar':
          wrapper.style.display='block';
          wrapper.style.width='100%';
          wrapper.style.minHeight='60px';
          wrapper.style.padding='10px';
          wrapper.innerHTML = `<nav style="display:flex;align-items:center;justify-content:space-between">
            <div contenteditable="true" class="brand" style="font-weight:700">Brand</div>
            <div class="nav-items" style="display:flex;gap:10px"></div>
          </nav>`;
          // add default nav items
          const items = ['Home','About','Contact'];
          const navItems = wrapper.querySelector('.nav-items');
          items.forEach(t=>{
            const a = el('a',{href:'#','class':'navbar-item',html:t});
            a.style.color='#0b1220';
            a.style.textDecoration='none';
            a.style.padding='6px 10px';
            a.style.borderRadius='6px';
            navItems.appendChild(a);
          });
          break;
        case 'text':
          wrapper.innerHTML = `<div contenteditable="true" style="font-size:16px;color:#0b1220">Editable text</div>`;
          break;
        case 'button':
          wrapper.innerHTML = `<button data-link="#" class="btn-element" style="background:${getComputedStyle(document.documentElement).getPropertyValue('--accent') || '#7c3aed'};color:white;border-radius:8px;padding:8px 12px;border:0">Click me</button>`;
          break;
        case 'image':
          wrapper.innerHTML = `<img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='400' height='200'><rect width='100%' height='100%' fill='%23edf2ff'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' fill='%2388a7ff' font-size='20'>Replace image</text></svg>" alt="image" style="max-width:100%;height:auto;display:block;border-radius:6px">`;
          wrapper.style.width='400px';
          wrapper.style.height='auto';
          break;
        case 'video':
          wrapper.innerHTML = `<video controls style="max-width:100%;display:block;border-radius:6px"><source src="" type="video/mp4">Your browser does not support the video tag.</video>`;
          wrapper.style.width='560px';
          wrapper.style.height='315px';
          break;
        case 'modal':
          // modal is hidden by default; button can target it via data-modal attribute
          const id = 'modal-'+Date.now()+Math.floor(Math.random()*1000);
          wrapper.dataset.modalId = id;
          wrapper.innerHTML = `<div id="${id}" class="modal" style="display:none;position:fixed;left:0;top:0;width:100%;height:100%;align-items:center;justify-content:center;z-index:9999">
            <div style="background:white;padding:20px;border-radius:10px;max-width:720px;width:90%;color:#0b1220">
              <div contenteditable="true" style="font-weight:700;font-size:18px">Modal title</div>
              <div contenteditable="true" style="margin-top:8px">Modal content</div>
              <div style="margin-top:12px;text-align:right"><button class="close-modal" style="padding:8px 12px;background:#7c3aed;color:white;border-radius:8px;border:0">Close</button></div>
            </div>
          </div>`;
          // show a small badge to indicate modal component
          wrapper.style.display='block';
          wrapper.style.width='100%';
          wrapper.style.height='auto';
          break;
      }
      makeInteractive(wrapper);
      return wrapper;
    }

    // Add from toolbox
    document.querySelectorAll('.tool-item').forEach(it=>{
      it.addEventListener('click', ()=> {
        const t = it.dataset.comp;
        const comp = createComponent(t);
        page.appendChild(comp);
        updateEditorsSoon();
      });
    });

    // make elements interactive: selectable, draggable, resizable
    function makeInteractive(node){
      // click selection
      node.addEventListener('click', (ev)=>{
        ev.stopPropagation();
        selectElement(node);
      });
      // allow inner editable elements to be edited but still selectable
      node.querySelectorAll('[contenteditable=true]').forEach(ce=>{
        ce.addEventListener('click', (e)=>{ e.stopPropagation(); selectElement(node); });
        ce.addEventListener('input', ()=> updateEditorsSoon());
      });

      // For buttons/links/modal close
      node.querySelectorAll('.close-modal').forEach(btn=>{
        btn.addEventListener('click', (e)=>{
          const modalRoot = btn.closest('.modal');
          if(modalRoot){ modalRoot.style.display='none'; }
        });
      });

      // Drag and resize via interact.js
      interact(node).draggable({
        allowFrom: node,
        listeners: {
          move (event) {
            const target = event.target;
            // ensure positioned for dragging
            if(getComputedStyle(target).position === 'static') target.style.position = 'relative';
            const x = (parseFloat(target.getAttribute('data-x')) || 0) + event.dx;
            const y = (parseFloat(target.getAttribute('data-y')) || 0) + event.dy;
            target.style.transform = `translate(${x}px, ${y}px)`;
            target.setAttribute('data-x', x);
            target.setAttribute('data-y', y);
            updateEditorsSoon();
          }
        }
      }).resizable({
        edges: { left: true, right: true, bottom: true, top: true },
        listeners: {
          move (event) {
            const target = event.target;
            let x = (parseFloat(target.getAttribute('data-x')) || 0);
            let y = (parseFloat(target.getAttribute('data-y')) || 0);

            // update the element's style
            target.style.width = event.rect.width + 'px';
            target.style.height = event.rect.height + 'px';

            // translate when resizing from top or left
            x += event.deltaRect.left;
            y += event.deltaRect.top;

            target.style.transform = 'translate(' + x + 'px,' + y + 'px)';

            target.setAttribute('data-x', x);
            target.setAttribute('data-y', y);
            updateEditorsSoon();
          }
        },
        modifiers: [
          interact.modifiers.restrictSize({
            min: { width: 30, height: 20 }
          })
        ]
      }).on('doubletap', event => {
        // reset transforms
        const t = event.currentTarget;
        t.style.transform = '';
        t.removeAttribute('data-x');t.removeAttribute('data-y');
        updateEditorsSoon();
      });
    }

    // selection logic
    document.addEventListener('click', (e)=>{
      if(!e.target.closest('#pageCanvas')) {
        // deselect
        selectElement(null);
      }
    });

    function selectElement(elm){
      if(selectedEl) selectedEl.classList.remove('selected-outline');
      selectedEl = elm;
      if(!elm){
        selectedLabel.textContent = 'none';
        renderProps(null);
        return;
      }
      elm.classList.add('selected-outline');
      selectedLabel.textContent = elm.dataset.type || elm.tagName.toLowerCase();
      renderProps(elm);
    }

    // Render properties panel for a selected element
    function renderProps(elm){
      propsPanel.innerHTML = '';
      if(!elm){
        propsPanel.innerHTML = '<div class="meta">No element selected. Click an element in the canvas to edit its properties.</div>';
        return;
      }
      const type = elm.dataset.type || elm.tagName.toLowerCase();
      const title = el('div',{html:`<strong style="font-size:15px">${type.toUpperCase()}</strong>`});
      propsPanel.appendChild(title);

      // Common: position controls
      const posRow = el('div',{class:'prop-row'},[
        el('label',{},'X/Y'),
        el('input',{class:'input',type:'text',id:'posXY',value:getTransformXY(elm)})
      ]);
      propsPanel.appendChild(posRow);

      const sizeRow = el('div',{class:'prop-row'},[
        el('label',{},'W / H'),
        el('div',{style:'display:flex;gap:8px;flex:1'},[
          el('input',{class:'input',id:'propW',value:elm.style.width || elm.offsetWidth+'px'}),
          el('input',{class:'input',id:'propH',value:elm.style.height || elm.offsetHeight+'px'})
        ])
      ]);
      propsPanel.appendChild(sizeRow);

      // color
      const bgRow = el('div',{class:'prop-row'},[
        el('label',{},'BG'),
        el('input',{class:'color-input',type:'color',id:'propBg',value=>(toHex(elm.style.backgroundColor) || '#ffffff')})
      ]);
      propsPanel.appendChild(bgRow);

      const txtColorRow = el('div',{class:'prop-row'},[
        el('label',{},'Color'),
        el('input',{class:'color-input',type:'color',id:'propColor',value=>(toHex(elm.style.color) || '#0b1220')})
      ]);
      propsPanel.appendChild(txtColorRow);

      // Specific controls by type
      if(type === 'navbar'){
        const navList = elm.querySelector('.nav-items');
        const navEdit = el('div',{class:'prop-row'},[
          el('label',{},'Items'),
          el('div',{class:'navbar-edit-list'}, [
            el('input',{class:'input',id:'newNavItem',placeholder:'Label'}),
            el('button',{class:'control-sm',id:'addNavItem'},'Add')
          ])
        ]);
        propsPanel.appendChild(navEdit);

        // render list
        const listWrap = el('div',{style:'margin-top:8px'});
        propsPanel.appendChild(listWrap);
        function refreshNavList(){
          listWrap.innerHTML='';
          const links = navList.querySelectorAll('a');
          links.forEach((a,i)=>{
            const row = el('div',{style:'display:flex;gap:8px;margin-bottom:6px;align-items:center'},[
              el('input',{class:'input',value:a.textContent}),
              el('input',{class:'input',value:a.getAttribute('href')||'#'}),
              el('button',{class:'control-sm',innerHTML:'Remove'},)
            ]);
            const removeBtn = row.querySelector('button');
            removeBtn.addEventListener('click', ()=>{ a.remove(); refreshNavList(); updateEditorsSoon(); });
            const inputs = row.querySelectorAll('input');
            inputs[0].addEventListener('input', ()=>{ a.textContent = inputs[0].value; updateEditorsSoon();});
            inputs[1].addEventListener('input', ()=>{ a.setAttribute('href', inputs[1].value); updateEditorsSoon();});
            listWrap.appendChild(row);
          });
        }
        refreshNavList();
        propsPanel.querySelector('#addNavItem').addEventListener('click', ()=>{
          const val = propsPanel.querySelector('#newNavItem').value || 'New';
          const a = el('a',{href:'#',class:'navbar-item',html:val});
          a.style.color='#0b1220';a.style.textDecoration='none';a.style.padding='6px 10px';a.style.borderRadius='6px';
          navList.appendChild(a);
          refreshNavList();
          updateEditorsSoon();
        });
      }

      if(type === 'button' || elm.querySelector('button')){
        const btn = elm.querySelector('button') || elm;
        const linkRow = el('div',{class:'prop-row'},[
          el('label',{},'Link'),
          el('input',{class:'input',id:'btnLink',value:btn.dataset.link || btn.getAttribute('data-link') || '#'})
        ]);
        propsPanel.appendChild(linkRow);

        propsPanel.querySelector('#btnLink').addEventListener('input', (e)=>{
          const v = e.target.value;
          btn.dataset.link = v;
          btn.onclick = ()=>{ if(v.startsWith('#')){ const modal = page.querySelector('[data-modal-id="'+v.replace('#','')+'"]'); } };
          updateEditorsSoon();
        });

        // link to modal
        const modalRow = el('div',{class:'prop-row'},[
          el('label',{},'Target'),
          el('input',{class:'input',id:'btnTarget',placeholder:'#modal-id'})
        ]);
        propsPanel.appendChild(modalRow);
        propsPanel.querySelector('#btnTarget').addEventListener('input', (e)=>{
          const v = e.target.value;
          const b = btn;
          if(v && v.startsWith('#')){
            b.dataset.modal = v.replace('#','');
            b.addEventListener('click', (ev)=>{
              const modalRoot = page.querySelector('[data-modal-id="'+b.dataset.modal+'"]');
              if(modalRoot){
                const modalNode = modalRoot.querySelector('.modal');
                if(modalNode) modalNode.style.display = 'flex';
              }
            });
          }
          updateEditorsSoon();
        });
      }

      // images/videos replacement
      if(type === 'image' || elm.querySelector('img')){
        const img = elm.querySelector('img') || elm;
        const row = el('div',{class:'prop-row'},[
          el('label',{},'Image'),
          el('input',{class:'input',id:'imgUrl',placeholder:'URL or leave empty then upload file'})
        ]);
        const fileRow = el('div',{class:'prop-row'},[
          el('label',{},'Upload'),
          el('input',{type:'file',class:'input',id:'imgFile'})
        ]);
        propsPanel.appendChild(row);
        propsPanel.appendChild(fileRow);

        propsPanel.querySelector('#imgUrl').addEventListener('change',(e)=>{
          const v = e.target.value;
          if(v) img.src = v;
          updateEditorsSoon();
        });
        propsPanel.querySelector('#imgFile').addEventListener('change',(e)=>{
          const f = e.target.files[0];
          if(!f) return;
          const reader = new FileReader();
          reader.onload = ()=>{ img.src = reader.result; updateEditorsSoon(); };
          reader.readAsDataURL(f);
        });
      }

      if(type === 'video' || elm.querySelector('video')){
        const vid = elm.querySelector('video');
        const row = el('div',{class:'prop-row'},[
          el('label',{},'Video URL'),
          el('input',{class:'input',id:'vidUrl',placeholder:'MP4 URL'})
        ]);
        const fileRow = el('div',{class:'prop-row'},[
          el('label',{},'Upload'),
          el('input',{type:'file',accept:'video/*',class:'input',id:'vidFile'})
        ]);
        propsPanel.appendChild(row);
        propsPanel.appendChild(fileRow);
        propsPanel.querySelector('#vidUrl').addEventListener('change',(e)=>{
          const v = e.target.value;
          if(v){
            const src = vid.querySelector('source') || vid.appendChild(el('source',{type:'video/mp4'}));
            src.src = v;
            vid.load();
            updateEditorsSoon();
          }
        });
        propsPanel.querySelector('#vidFile').addEventListener('change',(e)=>{
          const f = e.target.files[0];
          if(!f) return;
          const reader = new FileReader();
          reader.onload = ()=>{ const src = vid.querySelector('source') || vid.appendChild(el('source',{type:'video/mp4'})); src.src = reader.result; vid.load(); updateEditorsSoon(); };
          reader.readAsDataURL(f);
        });
      }

      // text editing - bind inner text controls
      const editableNodes = elm.querySelectorAll('[contenteditable=true]');
      if(editableNodes.length){
        editableNodes.forEach((node,i)=>{
          const row = el('div',{class:'prop-row'},[
            el('label',{}, i===0 ? 'Text' : 'Text '+(i+1)),
            el('input',{class:'input',value:node.innerText})
          ]);
          propsPanel.appendChild(row);
          row.querySelector('input').addEventListener('input', (e)=>{
            node.innerText = e.target.value;
            updateEditorsSoon();
          });
        });
      }

      // style updates: width/height, bg, color, apply button
      propsPanel.querySelector('#propW').addEventListener('change', (e)=>{
        elm.style.width = e.target.value;
        updateEditorsSoon();
      });
      propsPanel.querySelector('#propH').addEventListener('change', (e)=>{
        elm.style.height = e.target.value;
        updateEditorsSoon();
      });
      propsPanel.querySelector('#propBg').addEventListener('change', (e)=>{
        elm.style.backgroundColor = e.target.value;
        updateEditorsSoon();
      });
      propsPanel.querySelector('#propColor').addEventListener('change', (e)=>{
        elm.style.color = e.target.value;
        updateEditorsSoon();
      });
      propsPanel.querySelector('#posXY').addEventListener('change', (e)=>{
        const [x,y] = e.target.value.split(',').map(s=>parseFloat(s)||0);
        elm.style.transform = `translate(${x}px, ${y}px)`;
        elm.setAttribute('data-x', x); elm.setAttribute('data-y', y);
        updateEditorsSoon();
      });

      // small delete button
      const del = el('div',{style:'margin-top:10px;display:flex;gap:8px'},[
        el('button',{class:'btn ghost',id:'delEl'},'Delete'),
        el('button',{class:'btn',id:'cloneEl'},'Duplicate')
      ]);
      propsPanel.appendChild(del);
      propsPanel.querySelector('#delEl').addEventListener('click', ()=>{
        elm.remove();
        selectElement(null);
        updateEditorsSoon();
      });
      propsPanel.querySelector('#cloneEl').addEventListener('click', ()=>{
        const clone = elm.cloneNode(true);
        clone.dataset.id = 'c'+Date.now()+Math.floor(Math.random()*1000);
        makeInteractive(clone);
        page.appendChild(clone);
        updateEditorsSoon();
      });
    }

    function toHex(rgb){
      if(!rgb) return '#000000';
      if(rgb.startsWith('#')) return rgb;
      const m = rgb.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/i);
      if(!m) return '#000000';
      return '#'+[1,2,3].map(i=>parseInt(m[i]).toString(16).padStart(2,'0')).join('');
    }

    function getTransformXY(el){
      const tx = parseFloat(el.getAttribute('data-x'))||0;
      const ty = parseFloat(el.getAttribute('data-y'))||0;
      return tx+','+ty;
    }

    // sample layout
    document.getElementById('addSample').addEventListener('click', ()=>{
      page.innerHTML='';
      const nav = createComponent('navbar');
      page.appendChild(nav);
      const sec = createComponent('section');
      sec.querySelector('[contenteditable=true]').innerText = 'Welcome to your page';
      page.appendChild(sec);
      const hero = el('div',{style:'padding:24px;display:flex;gap:16px;align-items:center;justify-content:space-between;background:linear-gradient(90deg,#eef2ff,#ffffff);'});
      hero.style.margin='20px';
      hero.style.borderRadius='8px';
      hero.innerHTML = `<div style="max-width:60%"><h2 contenteditable="true">A great headline</h2><p contenteditable="true">Describe your product or project.</p><div style="margin-top:12px"><button class="btn-element" data-link="#" style="background:#7c3aed;color:#fff;padding:10px 14px;border-radius:8px;border:0">Get started</button></div></div><div><img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='320' height='200'><rect width='100%' height='100%' fill='%23eef2ff'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' fill='%2388a7ff' font-size='20'>Replace image</text></svg>" style="width:320px;border-radius:8px"></div>`;
      makeInteractive(hero);
      page.appendChild(hero);
      updateEditorsSoon();
    });

    // reset
    document.getElementById('resetBtn').addEventListener('click', ()=>{
      if(confirm('Reset the canvas?')){ page.innerHTML=''; updateEditorsSoon(); }
    });

    // page background
    pageBg.addEventListener('change', (e)=>{ page.style.background = e.target.value; updateEditorsSoon(); });

    // Preview toggle
    let preview = false;
    document.getElementById('togglePreview').addEventListener('click', ()=>{
      preview = !preview;
      document.getElementById('modeIndicator').textContent = preview ? 'Mode: Preview' : 'Mode: Edit';
      if(preview){
        // hide UI overlays
        document.querySelectorAll('.selected-outline').forEach(n=>n.classList.remove('selected-outline'));
        document.querySelectorAll('.app > aside, .app > .canvas-wrap .toolbar, .editors').forEach(x=>x.style.display = 'none');
        document.querySelector('.canvas-wrap').style.gridColumn = '1 / -1';
        workArea.style.padding = '40px';
        // open in full-page style: create an iframe that contains generated page
        const frame = document.createElement('iframe');
        frame.style.width='100%';frame.style.height='calc(100vh - 120px)';frame.style.border='0';frame.id='previewFrame';
        const html = generateFullHTML();
        document.body.appendChild(frame);
        const doc = frame.contentDocument || frame.contentWindow.document;
        doc.open(); doc.write(html); doc.close();
      } else {
        // restore UI
        document.querySelectorAll('.app > aside, .app > .canvas-wrap .toolbar, .editors').forEach(x=>x.style.display = '');
        const f = document.getElementById('previewFrame');
        if(f) f.remove();
      }
    });

    // generate full page HTML
    function generateFullHTML(){
      // We'll use page.innerHTML but clean up designer-only attributes (data-x etc) and include inline styles left on elements
      const clone = page.cloneNode(true);
      // remove interactive attributes and reset transforms by applying computed positions
      clone.querySelectorAll('[data-x]').forEach(n=>{
        const x = n.getAttribute('data-x')||0;
        const y = n.getAttribute('data-y')||0;
        // apply transform to style as translate
        n.style.transform = `translate(${x}px, ${y}px)`;
        n.removeAttribute('data-x'); n.removeAttribute('data-y');
        n.classList.remove('selected-outline');
      });
      // remove our class markers and make modal visible as needed inside wrapper
      clone.querySelectorAll('.comp').forEach(n=>{
        n.removeAttribute('data-type');
        n.removeAttribute('data-id');
        if(n.dataset.modalId) {
          // keep modal markup but do not show by default
          const mid = n.dataset.modalId;
          n.removeAttribute('data-modal-id');
        }
      });
      // extract inner HTML
      const inner = clone.innerHTML;
      // Minimal CSS for exported page: reset body and some defaults, plus modal handling
      const css = `:root{--accent:#7c3aed}
body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial;background:${page.style.background||'#fff'};color:#0b1220}
img,video{max-width:100%}
.modal{display:none;position:fixed;left:0;top:0;width:100%;height:100%;align-items:center;justify-content:center;z-index:9999}
.modal.active{display:flex}
.btn-element{cursor:pointer}
`;
      // JS: modal toggle and button link handling
      const js = `document.addEventListener('click', function(e){
  // button links
  const b = e.target.closest('[data-link]');
  if(b && b.dataset.link){
    // allow normal links
    if(b.dataset.link.startsWith('http')||b.dataset.link.startsWith('/')){ window.location.href = b.dataset.link; }
    else if(b.dataset.link.startsWith('#')){
      const id = b.dataset.link.replace('#','');
      const modal = document.querySelector('#'+id);
      if(modal){ modal.classList.add('active'); }
    }
  }
  // modal close
  if(e.target.matches('.close-modal')){ e.target.closest('.modal').classList.remove('active'); }
});
// Also support data-modal attribute
document.querySelectorAll('[data-modal]').forEach(b=>{
  b.addEventListener('click', function(){ const id = this.dataset.modal; const modal = document.querySelector('[data-modal-id=\"'+id+'\"]'); if(modal){ const m = modal.querySelector('.modal'); if(m) m.classList.add('active'); } });
});
`;

      return '<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><style>'+css+'</style></head><body>'+inner+'<script>'+js+'<\/script></body></html>';
    }

    // Editors: Monaco setup (load AMD loader)
    // We'll load monaco via CDN; ensure it initializes before creating editors
    (function loadMonaco(){
      const loaderSrc = 'https://unpkg.com/monaco-editor@0.39.0/min/vs/loader.js';
      const s = document.createElement('script'); s.src = loaderSrc;
      s.onload = ()=> {
        require.config({ paths: { 'vs': 'https://unpkg.com/monaco-editor@0.39.0/min/vs' }});
        require(['vs/editor/editor.main'], function() {
          window.htmlEditor = monaco.editor.create(document.getElementById('htmlEditor'), {
            value: '<!-- HTML will appear here -->',
            language: 'html',
            theme: 'vs-dark',
            automaticLayout: true,
            wordWrap: 'on',
            fontSize:12
          });
          window.cssEditor = monaco.editor.create(document.getElementById('cssEditor'), {
            value: '/* CSS will appear here */',
            language: 'css',
            theme: 'vs-dark',
            automaticLayout: true,
            fontSize:12
          });
          window.jsEditor = monaco.editor.create(document.getElementById('jsEditor'), {
            value: '// JS will appear here',
            language: 'javascript',
            theme: 'vs-dark',
            automaticLayout: true,
            fontSize:12
          });
          editorsReady = true;
          updateEditorsSoon();
        });
      };
      document.head.appendChild(s);
    })();

    // Copy buttons
    document.querySelectorAll('.copy-btn').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        const what = btn.dataset.copy;
        let text = '';
        if(what==='html') text = window.htmlEditor ? window.htmlEditor.getValue() : '';
        if(what==='css') text = window.cssEditor ? window.cssEditor.getValue() : '';
        if(what==='js') text = window.jsEditor ? window.jsEditor.getValue() : '';
        try{
          await navigator.clip
