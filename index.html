<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Webpage Designer — Fixed</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{--accent:#7c3aed}
    body{background:#071026;color:#e6eef8;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .workspace{min-height:420px}
    .selected{outline:2px dashed var(--accent);position:relative}
    .drag-over{outline:2px dashed #22c55e}
    .resize-handle{width:12px;height:12px;position:absolute;right:-6px;bottom:-6px;background:var(--accent);border-radius:2px;cursor:se-resize;z-index:50}
    textarea{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Roboto Mono,monospace}
    .panel-scroll{max-height:62vh;overflow:auto}
    .btn{transition:all .12s}
  </style>
</head>
<body class="h-screen flex flex-col">

  <header class="flex items-center justify-between p-4 bg-[#071026] border-b border-[#0f1724]">
    <div class="flex items-center gap-3">
      <h1 class="text-lg font-semibold">Webpage Designer</h1>
      <span class="text-sm text-gray-400">drag → arrange → style → export</span>
    </div>
    <div class="flex items-center gap-2">
      <button id="togglePreview" class="px-3 py-1.5 rounded bg-violet-600 btn">Switch to View</button>
      <button id="undoBtn" class="px-3 py-1.5 rounded bg-gray-800 btn">Undo</button>
      <button id="redoBtn" class="px-3 py-1.5 rounded bg-gray-800 btn">Redo</button>
      <button id="clearBtn" class="px-3 py-1.5 rounded bg-red-600 btn">Clear</button>
    </div>
  </header>

  <main class="flex flex-1 overflow-hidden">

    <aside id="elementsPanel" class="w-1/5 bg-[#071026] p-4 border-r border-[#0f1724] panel-scroll">
      <h3 class="font-semibold mb-3">Elements</h3>
      <div id="elements" class="space-y-2 text-sm">
        <div class="draggable bg-[#0f1724] p-2 rounded" draggable="true" data-type="navbar">Navbar</div>
        <div class="draggable bg-[#0f1724] p-2 rounded" draggable="true" data-type="header">Header</div>
        <div class="draggable bg-[#0f1724] p-2 rounded" draggable="true" data-type="hero">Hero</div>
        <div class="draggable bg-[#0f1724] p-2 rounded" draggable="true" data-type="section">Section</div>
        <div class="draggable bg-[#0f1724] p-2 rounded" draggable="true" data-type="card">Card</div>
        <div class="draggable bg-[#0f1724] p-2 rounded" draggable="true" data-type="image">Image</div>
        <div class="draggable bg-[#0f1724] p-2 rounded" draggable="true" data-type="video">Video</div>
        <div class="draggable bg-[#0f1724] p-2 rounded" draggable="true" data-type="form">Form</div>
        <div class="draggable bg-[#0f1724] p-2 rounded" draggable="true" data-type="input">Input</div>
        <div class="draggable bg-[#0f1724] p-2 rounded" draggable="true" data-type="list">List</div>
        <div class="draggable bg-[#0f1724] p-2 rounded" draggable="true" data-type="table">Table</div>
        <div class="draggable bg-[#0f1724] p-2 rounded" draggable="true" data-type="divider">Divider</div>
        <div class="draggable bg-[#0f1724] p-2 rounded" draggable="true" data-type="footer">Footer</div>
        <div class="draggable bg-[#0f1724] p-2 rounded" draggable="true" data-type="button">Button</div>
        <div class="draggable bg-[#0f1724] p-2 rounded" draggable="true" data-type="article">Article</div>
        <div class="draggable bg-[#0f1724] p-2 rounded" draggable="true" data-type="sidebar">Sidebar</div>
        <div class="draggable bg-[#0f1724] p-2 rounded" draggable="true" data-type="gallery">Gallery</div>
        <div class="draggable bg-[#0f1724] p-2 rounded" draggable="true" data-type="carousel">Carousel</div>
        <div class="draggable bg-[#0f1724] p-2 rounded" draggable="true" data-type="quote">Quote/Testimonial</div>
        <div class="draggable bg-[#0f1724] p-2 rounded" draggable="true" data-type="progress">Progress Bar</div>
      </div>
    </aside>

    <section class="flex-1 flex flex-col">

      <div id="editPreview" class="flex-1 flex overflow-hidden">

        <div id="workspace" class="workspace flex-1 bg-[#041024] m-4 rounded-lg p-4 border border-[#0f1724] overflow-auto">
          <p id="dropHint" class="text-gray-400">Drag elements here. Click an element to edit. Resize with handle. Drag to reorder.</p>
        </div>

        <div id="propertiesPanel" class="w-1/3 bg-[#041024] p-4 border-l border-[#0f1724] panel-scroll">
          <h3 class="font-semibold mb-3">Properties</h3>
          <div id="properties" class="text-sm text-gray-300">
            <p>Select an element to edit its properties.</p>
          </div>
        </div>
      </div>

      <div id="codePanel" class="bg-[#071026] p-4 border-t border-[#111827] grid grid-cols-3 gap-4">
        <div>
          <label class="text-xs text-gray-400">HTML</label>
          <textarea id="htmlCode" class="w-full h-36 bg-[#0b1220] p-2 rounded text-sm"></textarea>
          <div class="flex gap-2 mt-2">
            <button class="bg-violet-600 px-2 py-1 rounded" onclick="copyCode('htmlCode')">Copy</button>
            <button class="bg-gray-800 px-2 py-1 rounded" onclick="downloadFile('page.html', buildFullHtml())">Download</button>
          </div>
        </div>
        <div>
          <label class="text-xs text-gray-400">CSS</label>
          <textarea id="cssCode" class="w-full h-36 bg-[#0b1220] p-2 rounded text-sm"></textarea>
          <div class="flex gap-2 mt-2">
            <button class="bg-violet-600 px-2 py-1 rounded" onclick="copyCode('cssCode')">Copy</button>
            <button class="bg-green-600 px-2 py-1 rounded" onclick="generateCSS(true)">Generate Modern</button>
            <button class="bg-red-600 px-2 py-1 rounded" onclick="document.getElementById('cssCode').value=''">Clear</button>
          </div>
        </div>
        <div>
          <label class="text-xs text-gray-400">JS</label>
          <textarea id="jsCode" class="w-full h-36 bg-[#0b1220] p-2 rounded text-sm"></textarea>
          <div class="flex gap-2 mt-2">
            <button class="bg-violet-600 px-2 py-1 rounded" onclick="copyCode('jsCode')">Copy</button>
            <button class="bg-green-600 px-2 py-1 rounded" onclick="generateJS(true)">Generate Modern</button>
            <button class="bg-red-600 px-2 py-1 rounded" onclick="document.getElementById('jsCode').value=''">Clear</button>
          </div>
        </div>
      </div>

      <div id="viewPreview" class="hidden flex-1 bg-[#041024] m-4 rounded-lg p-2 border border-[#0f1724] overflow-auto">
        <iframe id="previewFrame" class="w-full h-full" sandbox="allow-scripts allow-same-origin"></iframe>
      </div>

    </section>
  </main>

  <script>
    const elements = document.querySelectorAll('.draggable');
    const workspace = document.getElementById('workspace');
    const properties = document.getElementById('properties');
    const propertiesPanel = document.getElementById('propertiesPanel');
    const htmlCode = document.getElementById('htmlCode');
    const cssCode = document.getElementById('cssCode');
    const jsCode = document.getElementById('jsCode');
    const previewFrame = document.getElementById('previewFrame');
    const viewPreview = document.getElementById('viewPreview');
    const togglePreviewBtn = document.getElementById('togglePreview');
    const dropHint = document.getElementById('dropHint');
    const elementsPanel = document.getElementById('elementsPanel');
    const codePanel = document.getElementById('codePanel');

    let selectedEl = null;
    let historyStack = [];
    let historyIndex = -1;

    // Drag from library
    elements.forEach(el => el.addEventListener('dragstart', e => e.dataTransfer.setData('type', el.dataset.type)));

    // Workspace dragover/drop
    workspace.addEventListener('dragover', e => { e.preventDefault(); highlightClosest(e.target); });
    workspace.addEventListener('dragleave', e => { clearHighlights(); });

    workspace.addEventListener('drop', e => {
      e.preventDefault(); clearHighlights();
      const type = e.dataTransfer.getData('type');
      const ref = findClosestChild(e.target);
      const node = createElement(type);
      if (!node) return;
      setupNode(node);
      if (ref && ref !== workspace) ref.insertAdjacentElement('beforebegin', node); else workspace.appendChild(node);
      dropHint.style.display = workspace.children.length ? 'none' : 'block';
      pushHistory(); updateCode();
    });

    // Element factory
    function createElement(type) {
      const map = {
        navbar: () => { const n = document.createElement('nav'); n.className = 'nav bg-[#071430] p-3 rounded m-2'; n.innerHTML = '<a href="#" class="mr-3 text-white">Home</a><a href="#" class="mr-3 text-gray-300">About</a><a href="#">Contact</a>'; return n; },
        header: () => { const h = document.createElement('header'); h.className = 'bg-[#0b1530] p-4 rounded m-2 text-xl font-semibold'; h.textContent = 'Header'; return h; },
        hero: () => { const d = document.createElement('div'); d.className = 'p-8 rounded m-2 text-center bg-gradient-to-r from-violet-600 to-indigo-600 text-white'; d.innerHTML = '<h1 class="text-2xl font-bold">Hero title</h1><p class="mt-2 text-sm">Hero subtitle</p>'; return d; },
        section: () => { const s = document.createElement('section'); s.className = 'bg-[#07192b] p-6 rounded m-2'; s.innerHTML = '<h2 class="text-lg font-semibold">Section</h2><p class="mt-2 text-sm text-gray-300">Content...</p>'; return s; },
        card: () => { const c = document.createElement('div'); c.className = 'card m-2 max-w-sm'; c.innerHTML = '<h3 class="font-semibold">Card title</h3><p class="text-sm text-gray-300">Card content</p>'; return c; },
        image: () => { const i = document.createElement('img'); i.src = 'https://via.placeholder.com/480x240'; i.alt = 'image'; i.className = 'm-2 rounded max-w-full h-auto'; return i; },
        video: () => { const v = document.createElement('video'); v.controls = true; v.className = 'm-2 rounded max-w-full'; return v; },
        form: () => { const f = document.createElement('form'); f.className = 'm-2 space-y-2'; f.innerHTML = '<input class="bg-[#0b1530] p-2 rounded w-full" placeholder="Name"><input class="bg-[#0b1530] p-2 rounded w-full" placeholder="Email"><button class="bg-violet-600 px-3 py-1 rounded text-white">Submit</button>'; return f; },
        input: () => { const ip = document.createElement('input'); ip.className = 'bg-[#0b1530] p-2 rounded m-2 max-w-xs block'; ip.placeholder = 'Input'; return ip; },
        list: () => { const ul = document.createElement('ul'); ul.className = 'list-disc list-inside m-2'; ul.innerHTML = '<li>Item 1</li><li>Item 2</li>'; return ul; },
        table: () => { const t = document.createElement('table'); t.className = 'table-auto border-collapse border border-[#203047] m-2'; t.innerHTML = '<tr><th class="border p-2">H1</th><th class="border p-2">H2</th></tr><tr><td class="border p-2">A</td><td class="border p-2">B</td></tr>'; return t; },
        divider: () => { const hr = document.createElement('hr'); hr.className = 'border-[#203047] my-2'; return hr; },
        footer: () => { const f = document.createElement('footer'); f.className = 'bg-[#071430] p-3 rounded m-2 text-center text-gray-300'; f.textContent = 'Footer'; return f; },
        button: () => { const b = document.createElement('button'); b.className = 'bg-violet-600 px-3 py-1 rounded text-white m-2 inline-block'; b.textContent = 'Button'; return b; },
        article: () => { const a = document.createElement('article'); a.className = 'bg-[#07192b] p-4 rounded m-2'; a.innerHTML = '<h2 class="text-lg font-semibold">Article</h2><p class="mt-2 text-sm text-gray-300">Some article content...</p>'; return a; },
        sidebar: () => { const s = document.createElement('aside'); s.className = 'bg-[#0b1530] p-4 rounded m-2 w-48'; s.innerHTML = '<h3 class="font-semibold">Sidebar</h3><ul class="mt-2 text-sm text-gray-300"><li>Item 1</li><li>Item 2</li></ul>'; return s; },
        gallery: () => { const g = document.createElement('div'); g.className = 'grid grid-cols-3 gap-2 m-2'; g.innerHTML = '<img src="https://via.placeholder.com/120" class="rounded"><img src="https://via.placeholder.com/120" class="rounded"><img src="https://via.placeholder.com/120" class="rounded">'; return g; },
        carousel: () => { const c = document.createElement('div'); c.className = 'm-2 p-4 bg-[#07192b] rounded text-center'; c.innerHTML = '<p class="text-sm text-gray-400">[Carousel placeholder]</p>'; return c; },
        quote: () => { const q = document.createElement('blockquote'); q.className = 'm-2 p-4 italic border-l-4 border-violet-600 bg-[#0b1530] text-gray-300'; q.textContent = '“This is a testimonial or quote.”'; return q; },
        progress: () => { const p = document.createElement('div'); p.className = 'm-2 w-full bg-[#203047] rounded'; p.innerHTML = '<div class="bg-violet-600 h-2 rounded" style="width:50%"></div>'; return p; }
      };
      return (map[type] || (() => null))();
    }

    function setupNode(node) {
      node.addEventListener('click', e => { e.stopPropagation(); selectNode(node); });
      enableReorder(node); enableResize(node);
    }

    function selectNode(node) {
      if (selectedEl) { selectedEl.classList.remove('selected'); removeResizeHandle(selectedEl); }
      selectedEl = node; selectedEl.classList.add('selected'); addResizeHandle(selectedEl); showProperties(selectedEl);
    }

    function showProperties(node) {
      properties.innerHTML = '';
      if (['BUTTON','A','H1','H2','H3','P','LI','HEADER'].includes(node.tagName)) properties.appendChild(rowInput('Text', node.textContent, v => { node.textContent = v; updateCode(); }));
      if (node.tagName === 'INPUT') properties.appendChild(rowInput('Placeholder', node.placeholder || '', v => { node.placeholder = v; updateCode(); }));
      if (['IMG','VIDEO'].includes(node.tagName)) properties.appendChild(rowInput('Source (URL)', node.src || '', v => { node.src = v; updateCode(); }));

      properties.appendChild(rowColor('Text color', rgbToHex(getComputedStyle(node).color), v => { node.style.color = v; updateCode(); }));
      properties.appendChild(rowColor('Background', rgbToHex(getComputedStyle(node).backgroundColor), v =>
